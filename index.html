<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>POS System with Items DB</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qz-tray/2.1.0/qz-tray.js"></script>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
  h1, h2 { text-align: center; }
  table { width: 100%; border-collapse: collapse; margin: 10px 0; }
  th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
  th { background: #333; color: #fff; }
  button { padding: 5px 10px; margin: 3px; }
  .total { font-size: 1.2em; text-align: right; margin-top: 10px; }
  .admin { background: #eee; padding: 10px; margin: 20px 0; }
</style>
</head>
<body>
<h1>Mini POS System</h1>

<div class="admin">
  <h2>Admin – Manage Products</h2>
  <input id="itemName" placeholder="Item Name">
  <input id="itemPrice" type="number" placeholder="Price">
  <button onclick="addProduct()">Add Product</button>
</div>

<div>
  <h2>Products</h2>
  <table id="productTable">
    <tr><th>Item</th><th>Price</th><th>Action</th></tr>
  </table>
</div>

<div>
  <h2>Cart</h2>
  <table id="cartTable">
    <tr><th>Item</th><th>Price</th><th>Qty</th><th>Subtotal</th></tr>
  </table>
  <div class="total">Total: ₱<span id="total">0</span></div>
</div>

<div>
  <button onclick="checkout()">Checkout</button>
  <button onclick="initialReading()">Initial Reading</button>
  <button onclick="xReading()">X Reading</button>
  <button onclick="zReading()">Z Reading</button>
</div>

<script>
  // ==============================
  // STORAGE & DATA
  // ==============================
  let cart = [];
  let dailySales = [];
  let opened = false;

  // Load products from localStorage
  function loadProducts() {
    let products = JSON.parse(localStorage.getItem("products") || "[]");
    return products;
  }

  // Save products
  function saveProducts(products) {
    localStorage.setItem("products", JSON.stringify(products));
  }

  // Add new product
  function addProduct() {
    let name = document.getElementById("itemName").value.trim();
    let price = parseFloat(document.getElementById("itemPrice").value);
    if (!name || isNaN(price)) return alert("Enter valid item name & price.");
    let products = loadProducts();
    products.push({ name, price });
    saveProducts(products);
    document.getElementById("itemName").value = "";
    document.getElementById("itemPrice").value = "";
    renderProducts();
  }

  // ==============================
  // RENDERING
  // ==============================
  function renderProducts() {
    let products = loadProducts();
    let table = document.getElementById("productTable");
    table.innerHTML = "<tr><th>Item</th><th>Price</th><th>Action</th></tr>";
    products.forEach((p, idx) => {
      table.innerHTML += `<tr>
        <td>${p.name}</td>
        <td>₱${p.price}</td>
        <td>
          <button onclick="addToCart('${p.name}', ${p.price})">Add</button>
          <button onclick="deleteProduct(${idx})">Del</button>
        </td>
      </tr>`;
    });
  }

  function deleteProduct(index) {
    let products = loadProducts();
    products.splice(index, 1);
    saveProducts(products);
    renderProducts();
  }

  function renderCart() {
    let table = document.getElementById("cartTable");
    table.innerHTML = "<tr><th>Item</th><th>Price</th><th>Qty</th><th>Subtotal</th></tr>";
    let total = 0;
    cart.forEach(item => {
      total += item.subtotal;
      table.innerHTML += `<tr>
        <td>${item.name}</td>
        <td>₱${item.price}</td>
        <td>${item.qty}</td>
        <td>₱${item.subtotal}</td>
      </tr>`;
    });
    document.getElementById("total").innerText = total;
  }

  // ==============================
  // POS FUNCTIONS
  // ==============================
  function addToCart(name, price) {
    if (!opened) {
      alert("Please run Initial Reading first!");
      return;
    }
    let item = cart.find(i => i.name === name);
    if (item) {
      item.qty++;
      item.subtotal = item.qty * item.price;
    } else {
      cart.push({ name, price, qty: 1, subtotal: price });
    }
    renderCart();
  }

  function checkout() {
    if (cart.length === 0) return alert("Cart is empty!");
    let total = cart.reduce((sum, item) => sum + item.subtotal, 0);
    let sale = { cart: [...cart], total, time: new Date().toLocaleString() };
    dailySales.push(sale);

    // Print receipt via QZ
    printReceipt(sale);

    // Open cash drawer
    openCashDrawer();

    cart = [];
    renderCart();
  }

  function printReceipt(sale) {
    let cmds = [
      "\x1B\x40", // Init
      "     MY STORE\n",
      "123 Main Street\n",
      "----------------------------\n",
      "Date: " + sale.time + "\n",
      "----------------------------\n"
    ];
    sale.cart.forEach(item => {
      cmds.push(item.name + " x" + item.qty + " ₱" + item.subtotal + "\n");
    });
    cmds.push("----------------------------\n");
    cmds.push("TOTAL: ₱" + sale.total + "\n");
    cmds.push("----------------------------\n");
    cmds.push("THANK YOU, COME AGAIN!\n\n\n");
    cmds.push("\x1D\x56\x41"); // Cut paper

    let config = qz.configs.create("Your_Printer_Name"); // change this
    qz.print(config, cmds).catch(err => console.error(err));
  }

  function openCashDrawer() {
    let cmds = [
      "\x1B\x70\x00\x19\xFA" // ESC p command
    ];
    let config = qz.configs.create("Your_Printer_Name");
    qz.print(config, cmds).catch(err => console.error(err));
  }

  // ==============================
  // READINGS
  // ==============================
  function initialReading() {
    if (opened) {
      alert("Day already opened.");
      return;
    }
    opened = true;
    alert("Initial Reading:\nOpening Balance: ₱0.00\nDate: " + new Date().toLocaleString());
  }

  function xReading() {
    if (!opened) return alert("Please run Initial Reading first!");
    let sum = dailySales.reduce((s, sale) => s + sale.total, 0);
    alert("X Reading (Mid-shift):\nTotal Sales: ₱" + sum + "\nTransactions: " + dailySales.length);
  }

  function zReading() {
    if (!opened) return alert("Please run Initial Reading first!");
    let sum = dailySales.reduce((s, sale) => s + sale.total, 0);
    alert("Z Reading (End of Day):\nTotal Sales: ₱" + sum + "\nTransactions: " + dailySales.length);
    dailySales = [];
    opened = false;
  }

  // ==============================
  // INIT
  // ==============================
  window.onload = () => {
    renderProducts();
    qz.websocket.connect().then(() => console.log("QZ Tray connected")).catch(err => console.error(err));
  };
</script>
</body>
</html>
